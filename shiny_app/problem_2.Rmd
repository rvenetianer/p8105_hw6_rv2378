---
title: "Problem 2"
output: 
  flexdashboard::flex_dashboard:
    orientation: row
    source_code: embed
  runtime: shiny
---

```{r setup, include = FALSE}
library(flexdashboard)
library(tidyverse)
library(janitor)
library(haven)
library(dplyr)
library(tidyr)
library(knitr)
library(ggridges)
library(ggthemes)
library(stringr)
library(viridis)
library(plotly)
library(hexbin)
library(httr)
library(jsonlite)
library(forcats)
library(tidytext)
```

```{r, load and clean data, include = FALSE, cache=TRUE}
get_all_inspections = function(url) {
  
  all_inspections = vector("list", length = 0)
  
  loop_index = 1
  chunk_size = 50000
  DO_NEXT = TRUE
  
  while (DO_NEXT) {
    message("Getting data, page ", loop_index)
    
    all_inspections[[loop_index]] = 
      GET(url,
          query = list(`$order` = "zipcode",
                       `$limit` = chunk_size,
                       `$offset` = as.integer((loop_index - 1) * chunk_size)
          )
      ) %>%
      content("text") %>%
      fromJSON() %>%
      as_tibble()
    
    DO_NEXT = dim(all_inspections[[loop_index]])[1] == chunk_size
    loop_index = loop_index + 1
  }
  
  all_inspections
  
}

url = "https://data.cityofnewyork.us/resource/9w7m-hzhe.json"

nyc_inspections = get_all_inspections(url) %>%
  bind_rows()

nyc_inspections = janitor::clean_names(nyc_inspections)

nyc_inspections$score <- as.numeric(nyc_inspections$score)

# Subset to bakeries only
bakery_inspec <- nyc_inspections [ which(nyc_inspections$cuisine_description == 'Bakery'), ] %>% select(-grade_date, -inspection_date, -phone, -record_date)

# Create mean score by zipcode column

```

### Chart A

```{r, echo = FALSE}
# Reorder???
bakery_inspec$zipcode <- factor(bakery_inspec$zipcode, levels = unique(bakery_inspec$zipcode)[order(bakery_inspec$score, decreasing = FALSE)])

# Plot of score by zipcode
plot_ly(x = ~bakery_inspec$zipcode, y = ~bakery_inspec$score, color = bakery_inspec$zipcode, type = "bar")
```


### Chart B

```{r}
# Plot scores for WaHi/Inwood bakeries
wahi_bakery <- bakery_inspec %>%
  group_by(dba) %>%
  filter(zipcode %in% c("10031", "10032", "10033", "10034", "10040"), critical_flag == 
           "Critical")

# Plot isn't working??
# plot_ly(x = ~wahi_bakery$inspection_type, y = ~wahi_bakery$score, color = bakery_inspec$inspection_type, type = "bar")
```

### Chart C

```{r bar plot criticals in each boro}
nyc_inspections %>%
  filter(boro != "Missing") %>% 
  plot_ly(x = ~boro, y=~score, color = ~critical_flag, type = "bar")
```


### Chart D

```{r box plot score in each boro}
nyc_inspections %>%
  filter(boro != "Missing") %>%
  plot_ly(y=~score, color = ~boro, type = "box")
```

